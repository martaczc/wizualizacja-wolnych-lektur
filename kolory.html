<!DOCTYPE html>
<head>
  <title>Kolory Wolnych Lektur</title>
  <meta name="description" content="Eksploracja kolorów występujących w książkach z bazy wolnelektury.pl.">
  <meta name="keywords" content="wizualizacja,kolory,d3.js,książka,lektura,kolorystyka,barwa">
  <meta name="author" content="Piotr Migdał">
  <meta charset="utf-8">
</head>
<style>

.color_point {
  stroke: #000;
  stroke-width: 0.5px;
}

.book_point {
  fill: #0f0;
  stroke: #000;
  stroke-width: 0.5px;
}

.book_point:hover {
  fill: #0f0;
  stroke: #000;
  stroke-width: 1.5px;
}

.lightness_point {
  stroke: #000;
  stroke-width: 0.5px;
}

.aux_line {
  stroke: #777;
  stroke-width: 2px;
}

div.tooltip {
                position: absolute;
                text-align: center;
                width: 150px;
            /*    height: 10px;
*/                padding: 8px;
                font: 10px sans-serif;
                background: #ffff99;
                border: solid 1px #aaa;
                border-radius: 8px;
                pointer-events: none;
            }

/*.saturation {
  stroke: #000;
  stroke-width: 0.5px;
}*/

/*.link {
  stroke: #999;
  stroke-opacity: .6;
}
*/
</style>
<body>
<script src="d3.v3.min.js"></script>
<script>

var width = 1000,
    height = 800;


var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.json("colored_books.json", function(error, books) {


//  var book = books[5]

  var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 1e-6);


  var rgb2x = function(r, g, b) {
    var tot = r + g + b
    if( tot != 0 ){
        return (g / 2 + b) / tot // (0 * r + 0.5 * g + 1 * b) / tot
    } else {
      return 0.5
    }
  };

  var rgb2y = function(r, g, b) {
    var tot = r + g + b
    if( tot != 0 ){
        return (Math.sqrt(3) / 2) * (r + b) / tot  //  (Math.sqrt(3)/2 * r + 0 * g + Math.sqrt(3)/2 * b) / tot
    } else {
      return 1 / Math.sqrt(3)
    }
  };

  var rgb2l = function(r, g, b) {
    return (r + b + g) / (3 * 255)
  };


  svg.append("line")
    .attr("class", "aux_line")
    .attr("x1", 50 + 346 * rgb2x(1, 0, 0))
    .attr("y1", 50 + 346 * rgb2y(1, 0, 0))
    .attr("x2", 50 + 346 * rgb2x(0, 1, 0))
    .attr("y2", 50 + 346 * rgb2y(0, 1, 0))

  svg.append("line")
    .attr("class", "aux_line")
    .attr("x1", 50 + 346 * rgb2x(0, 1, 0))
    .attr("y1", 50 + 346 * rgb2y(0, 1, 0))
    .attr("x2", 50 + 346 * rgb2x(0, 0, 1))
    .attr("y2", 50 + 346 * rgb2y(0, 0, 1))

  svg.append("line")
    .attr("class", "aux_line")
    .attr("x1", 50 + 346 * rgb2x(0, 0, 1))
    .attr("y1", 50 + 346 * rgb2y(0, 0, 1))
    .attr("x2", 50 + 346 * rgb2x(1, 0, 0))
    .attr("y2", 50 + 346 * rgb2y(1, 0, 0))


  svg.append("line")
      .attr("class", "aux_line")
      .attr("x1", 550)
      .attr("y1", 50)
      .attr("x2", 550)
      .attr("y2", 50 + 300)


  var cover = svg.append("image")
      .attr("xlink:href", "")
      .attr("x", 700)
      .attr("y", 50)
      .attr("width", 216)
      .attr("height", 300);


  var book_explorer = svg.append("g");

  var expl_scale_x = d3.scale.log()
      .domain([d3.min(books, function(d){ return d.word_count}),
        d3.max(books, function(d){ return d.word_count})])
      .range([40, 900]);

  var expl_scale_y = d3.scale.log()
      .domain([1, d3.max(books, function(d){ return d.color_count})])
      .range([750, 400]);

  var book_points = book_explorer.selectAll(".book_point")
      .data(books)
    .enter().append("circle")
      .attr("class", "book_point")
      .attr("r", 4)
      .attr("cx", function(d){ return expl_scale_x(d.word_count) })
      .attr("cy", function(d){ return expl_scale_y(d.color_count) })
      .style("fill", function(d) { 
        return d3.rgb(d.colors[0].r, d.colors[0].g, d.colors[0].b).toString();
      })
      .on("mouseover", function(d){ explorer_mouseover(d) })
      .on("mousemove", function(d){ explorer_mousemove(d) })
      .on("mouseout", function(d){ explorer_mouseout(d) })
      .on("click", function(d){ explorer_click(d) });
  
  // book_points.append("title")
  //     .text(function(d){ return d.author + ": " + d.title; });

  var explorer_mouseover = function(d){
    div.transition()
      .duration(200)
      .style("opacity", 1);
  };


  var explorer_mousemove = function(d){
    div
      .text(d.author + ": " + d.title)
      .style("left", (d3.event.pageX ) + "px")
      .style("top", (d3.event.pageY) + "px");
  };

  var explorer_mouseout = function(d){
    div.transition()
      .duration(200)
      .style("opacity", 1e-6);
  };

  var explorer_click = function(book){


    var points = svg.selectAll(".color_point")
        .data(book.colors);

    points.enter().append("circle")
      .attr("class", "color_point");

    points
      .attr("r", function(d) { return 4 * Math.sqrt(d.count); } )
      .attr("cx", function(d) { return 50 + 346 * rgb2x(d.r, d.g, d.b); })
      .attr("cy", function(d) { return 50 + 346 * rgb2y(d.r, d.g, d.b); })
      .style("fill", function(d) { return d3.rgb(d.r, d.g, d.b).toString(); });

    points.exit().remove();


    var lightness = svg.selectAll(".lightness_point")
      .data(book.colors);

    lightness.enter().append("circle")
      .attr("class", "lightness_point");

    lightness
      .attr("r", function(d) { return 4 * Math.sqrt(d.count); } )
      .attr("cx", 550)
      .attr("cy", function(d) { return 50 + 300 * (1 - rgb2l(d.r, d.g, d.b)); })
      .style("fill", function(d) { return d3.rgb(d.r, d.g, d.b).toString(); });

    lightness.exit().remove();


    cover.attr("xlink:href", book.cover);
  };

});

</script>